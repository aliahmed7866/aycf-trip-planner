{% extends "base.html" %}
{% block content %}

<script>
  // Inject city options for the picker (from backend). Keep bases curated.
  window.__PICKER_OPTIONS__ = {
    bases: {{ base_options|tojson }},
    hubs: {{ hub_options|tojson }},
    targets: {{ target_options|tojson }},
  };
</script>

<div class="row g-3 mt-2">
  <div class="col-lg-8">
    <div class="card glass border-0 shadow-sm">
      <div class="card-body p-4">
        <div class="d-flex flex-wrap align-items-start justify-content-between gap-2 mb-3">
          <div>
            <h1 class="h4 mb-1">Plan routes (phone-friendly)</h1>
            <div class="text-muted-2">
              Choose <span class="badge badge-soft">bases</span>, <span class="badge badge-soft">hubs</span>, and <span class="badge badge-soft">targets</span>.
              Use the picker to search quickly through all Wizz cities.
            </div>
          </div>
          <div class="text-muted-2 small">
            <div>Base city: Manchester</div>
            <div>Use: Liverpool / London Luton</div>
          </div>
        </div>

        <form method="post">

          <!-- Hidden inputs that hold the chosen cities -->
          <div id="hidden-bases">
            {% for v in (form.getlist('bases') if form else []) %}
              <input type="hidden" name="bases" value="{{ v }}">
            {% endfor %}
          </div>
          <div id="hidden-hubs">
            {% for v in (form.getlist('hubs') if form else []) %}
              <input type="hidden" name="hubs" value="{{ v }}">
            {% endfor %}
          </div>
          <div id="hidden-targets">
            {% for v in (form.getlist('targets') if form else []) %}
              <input type="hidden" name="targets" value="{{ v }}">
            {% endfor %}
          </div>

          <div class="row g-4">

            <div class="col-md-4">
              <label class="form-label text-light">Travel start date</label>
              <input type="date" name="start_date" class="form-control" value="{{ (form.start_date if form else '') }}">
              <div class="text-muted-2 small mt-1">Used for live checks on Wizz/WIZZ Link.</div>
            </div>

            <div class="col-md-4">
              <label class="form-label text-light">Travel end date</label>
              <input type="date" name="end_date" class="form-control" value="{{ (form.end_date if form else '') }}">
              <div class="text-muted-2 small mt-1">Optional — leave blank for open-ended.</div>
            </div>

            <div class="col-md-4">
              <label class="form-label text-light">Results</label>
              <input type="number" name="top_n" min="1" max="200" class="form-control" value="{{ (form.top_n if form else '25') }}">
              <div class="text-muted-2 small mt-1">Top N suggestions (max 200).</div>
            </div>

            <div class="col-md-4">
              <label class="form-label text-light">History lookback (days)</label>
              <input type="number" name="lookback_days" min="7" max="730" class="form-control" value="{{ (form.lookback_days if form else '180') }}">
              <div class="text-muted-2 small mt-1">How much history to score stability.</div>
            </div>

            <div class="col-md-4">
              <label class="form-label text-light">Minimum self-transfer</label>
              <select class="form-select" name="min_transfer_minutes">
                {% set mt = (form.min_transfer_minutes if form else '150') %}
                <option value="120" {% if mt == '120' %}selected{% endif %}>2h (aggressive)</option>
                <option value="150" {% if mt == '150' %}selected{% endif %}>2h 30m (recommended)</option>
                <option value="180" {% if mt == '180' %}selected{% endif %}>3h (safe)</option>
              </select>
              <div class="text-muted-2 small mt-1">Rule-of-thumb for self-transfer hubs.</div>
            </div>

            <div class="col-md-4 d-flex align-items-end">
          <input type="hidden" id="require_return_to_base" name="require_return_to_base" value="on">
</div>
            </div>

            <div class="col-12"><hr class="border-light opacity-25 my-2"></div>

            <!-- Picker summaries -->
            <div class="col-12">
              <div class="card glass border-0 mb-3">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <div class="fw-semibold">Bases</div>
                      <div class="text-muted-2 small" id="count-bases">—</div>
                    </div>
                    <button class="btn btn-outline-light" data-picker-open="bases">Choose</button>
                  </div>
                  <div class="mt-2" id="summary-bases"></div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card glass border-0 mb-3">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <div class="fw-semibold">Hubs</div>
                      <div class="text-muted-2 small" id="count-hubs">—</div>
                    </div>
                    <button class="btn btn-outline-light" data-picker-open="hubs">Choose</button>
                  </div>
                  <div class="mt-2" id="summary-hubs"></div>

                  <div class="text-muted-2 small mt-2">Quick add hubs:</div>
                  <div class="d-flex flex-wrap gap-2 mt-1">
                    {% for c in ["London Luton","Bucharest","Budapest","Warsaw","Gdansk","Krakow","Katowice"] %}
                      <button type="button" class="btn btn-sm btn-outline-light" onclick="quickAdd('hubs','{{c}}')">{{c}}</button>
                    {% endfor %}
                  </div>

                  <div class="text-muted-2 small mt-2">Tip: add more hubs to increase return options.</div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card glass border-0 mb-3">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <div class="fw-semibold">Targets</div>
                      <div class="text-muted-2 small" id="count-targets">—</div>
                    </div>
                    <button class="btn btn-outline-light" data-picker-open="targets">Choose</button>
                  </div>
                  <div class="mt-2" id="summary-targets"></div>

                  <div class="text-muted-2 small mt-2">Quick add targets:</div>
                  <div class="d-flex flex-wrap gap-2 mt-1">
                    {% for c in ["Kutaisi","Yerevan","Amman","Dubai","Abu Dhabi","Hurghada","Sharm el-Sheikh"] %}
                      <button type="button" class="btn btn-sm btn-outline-light" onclick="quickAdd('targets','{{c}}')">{{c}}</button>
                    {% endfor %}
                  </div>

                  <div class="text-muted-2 small mt-2">Pick “exotic” places to maximise AYCF value.</div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label mt-2 text-light">Custom targets (optional)</label>
              <input type="text" class="form-control" name="custom_targets"
                     placeholder="Comma-separated city names (as in dataset), e.g. Tenerife, Gran Canaria, Marrakech"
                     value="{{ (form.custom_targets if form else '') }}">
              <div class="text-muted-2 small mt-1">Use this for destinations not listed yet.</div>
            </div>

            <div class="col-12">
  <div class="d-sm-none" style="position: sticky; bottom: 0; z-index: 1020; padding-top: .5rem;">
    <button class="btn btn-primary btn-lg w-100" type="submit">Find routes</button>
  </div>
  <div class="d-none d-sm-flex justify-content-end mt-2">
    <button class="btn btn-primary btn-lg px-4" type="submit">Find routes</button>
  </div>
</div>

          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card glass border-0 shadow-sm">
      <div class="card-body p-4">
        <h2 class="h6 mb-3">How to use this</h2>
        <ol class="text-muted-2 small mb-0">
          <li>Pick bases/hubs/targets using the search picker.</li>
          <li>Generate suggestions ranked by stability.</li>
          <li>Verify live times and layovers with WIZZ Link.</li>
        </ol>
        <hr class="border-light opacity-25 my-3">
        <div class="text-muted-2 small">
          <div class="fw-semibold text-light mb-1">Quick tips</div>
          <ul class="mb-0">
            <li>Keep 2h30+ at hubs for self-transfer.</li>
            <li>Weekend mode enforces a return (low risk).</li>
            <li>Refresh data daily (top right) if needed.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- City Picker Modal -->
<div class="modal fade" id="cityPickerModal" tabindex="-1" aria-labelledby="pickerTitle" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-scrollable">
    <div class="modal-content glass border-0">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="pickerTitle">Select cities</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="d-flex gap-2 align-items-center mb-2">
          <input id="picker-search" class="form-control" placeholder="Search cities… (e.g. kut, abu, amm)">
          <button id="picker-all" class="btn btn-outline-light">All</button>
          <button id="picker-none" class="btn btn-outline-light">None</button>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted-2 small" id="picker-hint">—</div>
          <div class="text-muted-2 small"><span id="picker-livecount">0 selected</span></div>
        </div>

        <div id="picker-list" class="list-group"></div>
      </div>

      
          <div class="mb-3">
            <label class="form-label fw-semibold text-light text-light">Trip mode</label>
            <div class="btn-group w-100" role="group" aria-label="Trip mode">
              <input type="radio" class="btn-check" name="trip_mode" id="mode_weekend" value="weekend" checked>
              <label class="btn btn-outline-light" for="mode_weekend">Weekend</label>

              <input type="radio" class="btn-check" name="trip_mode" id="mode_oneway" value="oneway">
              <label class="btn btn-outline-light" for="mode_oneway">One-way</label>
            </div>
            <div class="form-text text-light opacity-75">Weekend = requires a return to the same base. One-way = return optional.</div>
          </div>

<div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="picker-done" data-bs-dismiss="modal">Done</button>
      </div>
    </div>
  </div>
</div>


<script>
  function addHidden(name, value){
    const host = document.getElementById('hidden-' + name);
    if (!host) return false;
    const existing = new Set(Array.from(document.querySelectorAll(`input[name='${name}']`)).map(i => i.value));
    if (existing.has(value)) return false;
    const inp = document.createElement('input');
    inp.type = 'hidden'; inp.name = name; inp.value = value;
    host.appendChild(inp);
    return true;
  }
  function renderChips(name){
    const wrap = document.getElementById('summary-' + name);
    const count = document.getElementById('count-' + name);
    if (!wrap || !count) return;
    const values = Array.from(document.querySelectorAll(`input[name='${name}']`)).map(i => i.value).filter(Boolean).sort();
    count.textContent = values.length ? `${values.length} selected` : 'None selected';
    wrap.innerHTML = '';
    const max = 6;
    values.slice(0,max).forEach(v => {
      const s = document.createElement('span');
      s.className = 'badge badge-soft me-1 mb-1';
      s.textContent = v;
      wrap.appendChild(s);
    });
    if (values.length > max){
      const m = document.createElement('span');
      m.className = 'badge badge-soft-2 me-1 mb-1';
      m.textContent = `+${values.length-max} more`;
      wrap.appendChild(m);
    }
  }
  function quickAdd(name, value){
    const ok = addHidden(name, value);
    renderChips(name);
    if (ok) showToast('Added ' + value);
  }
  document.addEventListener('DOMContentLoaded', () => {
    renderChips('bases'); renderChips('hubs'); renderChips('targets');
  });
</script>

{% endblock %}
